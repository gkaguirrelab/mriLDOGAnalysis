function correctedFuncPath = regressMotion(funcZipPath, motionParamsPath, outputFolder)
% Pre-process the ldog func data to regress out the effects of motion
%
% Syntax:
%  correctedFuncPath = regressMotion(funcZipPath, motionParamsPath)
%
% Description
%   Loads a volumetric, 4D fMRI dataset and the motion parameter vectors
%   generated by the XXX routine. These vectors are treated as a regression
%   matrix and the effect of motion is removed from the data (preserving
%   signal mean). The motion-cleaned data is written back to disk.
%
%   Requires the Freesurfer MATLAB library to handle read/write operations.
%
% Inputs:
%   funcZipPath           - String. Path to zip files that contain the
%                           fMRI data to be analyzed. These zip files are
%                           the output of the ldogFunc.
%   motionParamsPath      - String. Path to a .txt file that contains the
%                           motion covariates.
%
% Optional key/value pairs:
%   none
%
% Outputs:
%   correctedFuncPath     - String. Full path to the uncompressed
%                           functional MRI data file that has undergone
%                           regression to remove the effects of motion.
%
% Examples:
%{
    funcZipPath = 'N292_112Reps_RightEyeStim_preprocessedFunc.zip';
    motionParamsPath = 'N292_112Reps_RightEyeStim_motion_params.txt';
    regressMotion(funcZipPath, motionParamsPath);
%}

%% Parse inputs
p = inputParser; p.KeepUnmatched = false;

% Required
p.addRequired('funcZipPath',@isstr);
p.addRequired('motionParamsPath',@isstr);
p.addRequired('outputFolder',@isstr);

% Parse
p.parse(funcZipPath, motionParamsPath, outputFolder)

% Create a temp directory to hold the zip file output
zipDir = fullfile(fileparts(funcZipPath),tempname('.'));
mkdir(zipDir)

% Uncompress the zip archive into the zipDir.
command = ['unzip -q -n ' funcZipPath ' -d ' zipDir];
system(command);

% Find and load the functional data
acquisitionList = dir(fullfile(zipDir,'*.nii.gz'));

% Detect if something weird happened
if length(acquisitionList)~=1
    error('regressMotion:weirdFuncDataPath','Found either zero or more than one functional data sets');
end

% Load the data
rawName = fullfile(acquisitionList(1).folder,acquisitionList(1).name);
thisAcqData = MRIread(rawName);

% Reshape into a matrix
data = thisAcqData.vol;
data = single(data);
data = reshape(data, [size(data,1)*size(data,2)*size(data,3), size(data,4)]);
data(isnan(data)) = 0;

% Load and format the motion covariates
X = readmatrix(motionParamsPath);

% Check that the motion covariates and data match
if size(X,1) ~= size(data,2)
    error('regressMotion:mismatchRegressors','The data and motion parameters have different temporal lengths');
end

% Store the warning state
warningState = warning;

% Silence warnings.
warning('off','MATLAB:rankDeficientMatrix');

% Loop through the voxels and regress out the motion component
for vv = 1:size(data,1)
    datats = data(vv,:)';
    if all(datats==0)
        continue
    end
    meants = mean(datats);
    beta = X\datats;
    cleants = datats - X*beta + meants;
    data(vv,:) = cleants';
end

% Restore the warning state.
warning(warningState);

% Put the cleaned data back into the acquisition
thisAcqData.vol = data;

% Set the save name
newName = strrep(acquisitionList(1).name,'_preprocessed_','_preprocessedMoReg_');

% Save the motion corrected fMRI data
correctedFuncPath = fullfile(outputFolder,newName);
MRIwrite(thisAcqData,correctedFuncPath);

end % Main function
